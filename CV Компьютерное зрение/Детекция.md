## Метрика  
##### mAP  
Метрика крайне замороченная. Нужно свести в одно числа 2 параметра:  
1. Точность бокса  
2. Confidence класса  
Для каждого класса:  
1. Хотим получить Precision Recall Curve.  
2. Цикл по трешхолдам confidence.  
3. Трешхолд по IOU => TP, FP, FN.  
4. mAP = area under PR Curve.  
Выход метрики заключён в диапазоне `[0,1]`.  
  
## Подход детекции  
##### Non Maximum Suppression  
Задача детекции - предсказать много боксов, а потом отфильтровать, чтобы оставить лучший.  
![[Pasted image 20230607173315.png]]  
  
## Детекторы  
### Одноэтапные методы  
#### YOLO'15 (You Only Look Once)  
Первая попытка сделать возможной детекцию в реальном времени.  
  
На выходе модели должно быть:  
- 4 координаты краёв бокса  
- 1 координата центра бокса  
- Вероятность принадлежности к каждому классу  
Т.е. сеть представляет из себя набор ячеек, и для каждой классификатор и 5 регрессоров.  
![[Pasted image 20230607183108.png]]  
Обучение сети:  
1. Берётся сеть для классификации (VGG или ResNet), отрезается Dense слой. Выход такой сети будет отдавать heatmap (тепловую карту) объектов.  
2. Картинка делится на матрицу регионов S x S.  
3. Каждая ячейка описывает несколько вариантов местоположения бокса для одного и того же объекта.   
4. Классификатор для каждой ячейки оценивает принадленость к определенному классу.  
5. Применяется [[Детекция#Non Maximum Suppression|Non Maximum Suppression]] для выделения лучшего бокса.  
Последний слой сети, принимающий решение об окончательном расположении бокса для детекции объекта, а также уверенность принадлежности к классу, работает с тензором размерности S x S x (5B + C), где S x S - количество ячеек, B - количество предсказываемых боксов для ячейки), C - количество классов объектов.  
  
>Такой метод быстрее, чем R-CNN за счёт того, что поддерживает дробление на определенное количество вместо динамичного определения региона и принятия для него решения. В качестве проблемы нужно отметить плохое качество распознавания объектов сложной формы или группы небольших объектов.  
>Также стоит отметить, что энкодер YOLO очень замороченный, поэтому немодифицированную изначальную её версию будет довольно трудно обучать.  
  
#### SSD'15 (Single Shot Detection)  
В YOLO имелась проблема с масштабированием, поэтому было предложено использовать концепцию [[Сегментация#FPN|Пирамидальной иерархии выводов (Как FPN)]].  
![[Pasted image 20230607190006.png]]  
Принятие решения по детекции объектов происходит не только на основе последнего сверточного слоя, но основании всех слоев энкодера.   
  
Такое решение помогает детектировать объекты разных масштабов по той причине, что первые слои энкодера хорошо определяют рамки мелких объектов. Последние же слои - крупных объектов.  
  
В отличие от YOLO, SSD не разбивает изображение на сетку определенного размера, а предсказывает смещение ключевых рамок.   
  
>Скорость распознавания меньше, чем у YOLO, но у SSD точность детектирования лучше.  
  
### Двухэтапные методы  
#### R-CNN'14  
R-CNN = Selective Search + Classification  
Сверяясь с картинкой ниже, описание двух этапов:  
  
Первый этап - определение возможных регионов (proposals) каких-либо объектов. Каким-то способом кластеризуются объекты, которые могут быть похожи на предсказываемые объекты. Для каждого кластера, которые остались на последнем слое, вычисляется bounding box.   
  
Второй этап - прогнать через каждый регион классификатор, определить, есть ли там объект из набора предсказываемых классов, и определить вероятность отнесения к какому-либо классу.  
![[Pasted image 20230607192836.png]]  
>Работает, но очень медленно. Обработка одного кадра 50 секунд - неприемлемо для реальных кейсов.   
  
#### Fast R-CNN'15  
В этой сети была решена проблема долгой обработки кропов. Теперь всё изображение сначала пропускается через CNN, а затем уже на heatmap ищутся proposals.   
![[Pasted image 20230607213601.png]]  
На картинке слева R-CNN, а справа Fast R-CNN.   
Поскольку предсказанные селективным поиском регионы имеют разный размер, нужно привести их к единому, так как они будут поданы на вход полносвязным слоям. Для этого используется **RoiPooling**.  
  
**RoiPooling** (Region of interest pooling) - операция, которая откусывает от Roi максимальный регион и подаёт его дальше. Как именно она это делает - дальше:   
Roi - это регионы, которые представляют интерес. Они как раз и подаются на вход pooling.   
В рамках RoiPooling Roi делится на сетку, размерность ячеек которой совпадает с размерностью выхода. Среди ячеек отбирается максимальная и отправляется дальше в полносвязный слой. ^ec48c1  
  
>Таким образом, второй этап R-CNN переходит в первый. Тяжеловесная CNN выполняется только один раз, что значительно сокращает время обработки. Если R-CNN обрабатывала бы картинку 50 секунд, то Fast R-CNN будет обрабатывать ее **2 секунды**! Прирост составил **25 раз**.  
  
#### Faster R-CNN'15  
Модификация Fast R-CNN. Слабым местом в ней оказался уже селективный поиск. Поэтому было предложено вычислять регионы с помощью отдельного модуля **RPN** (Region Proposal Network). RPN - свёрточная сеть, выполняющая роль генератора регионов.   
  
Anchor boxes - скользящие окна, которые проходятся по всей картинке. Имеют различные форму и масштаб. Для одного и того же масштаба, как правило, выбирается 3 положения: квадратный, вертикальный прямоугольник, горизонтальный прямоугольник, как на картинке ниже.  
![[Pasted image 20230607215733.png|300]]  
  
Алгоритм работы генератора регионов (на картинке ниже это слой "Предложения регионов"):  
1. Каждый anchor box (ключевая рамка) скользящим окном проходится по всей картинке и отдает заданное количество регионов.  
2. Далее каждый регион отправляется в box-classification-layer (сокр. cls), чтобы рассчитать вероятность нахождения в регионе объекта.  
3. Также регионы попадают в box-regression-layer (сокр. reg layer), который отвечает за предсказание смещения bounding box.  
4. После прохождения всего RPN, следует [[Детекция#^ec48c1|RoiPooling]], который откусывает максимальный регион заданного размера.  
![[Pasted image 20230607215205.png|400]]  
Далее, в слое, который на картинке называется "Классификация", регион заданного размера подаётся на классификатор и регрессоры, которые определяют softmax принадлежностей к классам и смещения границ bounding box соответственно.  
  
Так как классификацией и регрессиями занимается как RPN, так и сеть в целом, функция потерь учитывает оба результата.  
  
Есть возможность использовать [[Сегментация#FPN (Feature Pyramid Networks)|FPN]], чтобы немного увеличить точность предсказания.  
  
>Вычисления сети проходят в 10 раз быстрее, чем с Fast R-CNN. Если та модель отрабатывает за 2 секунды, то Faster R-CNN за 0.2 секунды.  
